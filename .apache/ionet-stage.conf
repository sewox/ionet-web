<VirtualHost *:80>
    ServerName stage.ionet.com.tr
    ServerAlias staging.ionet.com.tr
    
    DocumentRoot /var/www/ionet-web/dist
    
    # Logging
    ErrorLog ${APACHE_LOG_DIR}/ionet-stage-error.log
    CustomLog ${APACHE_LOG_DIR}/ionet-stage-access.log combined
    
    # CRITICAL: API requests MUST be proxied to backend BEFORE any rewrite rules
    # This prevents API requests from being rewritten to index.html
    ProxyPreserveHost On
    ProxyPass /ionet-web/api http://localhost:3001/ionet-web/api
    ProxyPassReverse /ionet-web/api http://localhost:3001/ionet-web/api
    
    # Uploads directory
    ProxyPass /ionet-web/uploads http://localhost:3001/ionet-web/uploads
    ProxyPassReverse /ionet-web/uploads http://localhost:3001/ionet-web/uploads
    
    # Frontend static files
    <Directory "/var/www/ionet-web/dist">
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Enable Apache rewrite module
        RewriteEngine On
        RewriteBase /ionet-web
        
        # Don't rewrite files or directories that exist
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        
        # CRITICAL: Don't rewrite API requests - they should be proxied above
        RewriteCond %{REQUEST_URI} !^/ionet-web/api/
        RewriteCond %{REQUEST_URI} !^/ionet-web/uploads/
        
        # All other requests go to index.html (SPA routing)
        RewriteRule ^ /ionet-web/index.html [L]
    </Directory>
    
    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # CORS headers (optional if backend handles it)
    # Header always set Access-Control-Allow-Origin "*"
    # Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    # Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
</VirtualHost>

# HTTPS Configuration (recommended for production)
# <VirtualHost *:443>
#     ServerName stage.ionet.com.tr
#     ServerAlias staging.ionet.com.tr
#     
#     DocumentRoot /var/www/ionet-web/dist
#     
#     SSLEngine on
#     SSLCertificateFile /etc/letsencrypt/live/stage.ionet.com.tr/fullchain.pem
#     SSLCertificateKeyFile /etc/letsencrypt/live/stage.ionet.com.tr/privkey.pem
#     
#     # Same configuration as HTTP above
#     # ... (duplicate all settings from HTTP VirtualHost)
# </VirtualHost>
