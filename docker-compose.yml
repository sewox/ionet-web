version: '3.8'

services:
  app:
    build:
      context: .
      args:
        VITE_BASE_PATH: ${VITE_BASE_PATH:-/}
        VITE_API_URL: ${VITE_API_URL}
        VITE_APP_ENV: ${VITE_APP_ENV:-staging}

    restart: unless-stopped

    # Expose port for Dokploy reverse proxy
    ports:
      - "${PORT:-3001}:3001"

    environment:
      - NODE_ENV=${NODE_ENV:-staging}
      - PORT=${PORT:-3001}
      - DB_PATH=${DB_PATH:-server/db/stage.db}
      - UPLOAD_DIR=${UPLOAD_DIR:-server/uploads/stage}
      - JWT_SECRET=${JWT_SECRET}
      - ADMIN_PASSWORD_HASH=${ADMIN_PASSWORD_HASH}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - SITE_URL=${SITE_URL}
      - MAIL_TO=${MAIL_TO:-admin@example.com}
      - MAIL_FROM=${MAIL_FROM:-noreply@example.com}

    volumes:
      - db-data:/app/server/db
      - uploads-data:/app/server/uploads

    # Dokploy labels for traefik routing (if used)
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ionet.rule=Host(`${SITE_URL}`)"
      - "traefik.http.services.ionet.loadbalancer.server.port=3001"

    healthcheck:
      test: [ "CMD-SHELL", "node -e \"require('http').get('http://localhost:3001/v1/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})\"" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  db-data:
  uploads-data:
